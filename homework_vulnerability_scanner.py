# homework_vulnerability_scanner.py
import csv
import requests
import time
import matplotlib.pyplot as plt # Імпорт бібліотеки для візуалізації

# Обрані програми для сканування вразливостей
MY_APPS = [
    "Google Chrome",
    "Git",
    "Visual Studio Community 2022",
    "Cloudflare WARP",
    "Wireshark"
]


def get_cvss_info(metrics: dict):
    """
    Отримує CVSS score та severity.
    Пріоритет: CVSS v3.1 → v3.0 → v2
    """
    for version in ["cvssMetricV31", "cvssMetricV30", "cvssMetricV2"]:
        if version in metrics and metrics[version]:
            cvss_data = metrics[version][0].get("cvssData", {})
            return cvss_data.get("baseScore"), cvss_data.get("baseSeverity")
    return None, None


def search_vulnerabilities(app_name: str, limit: int = 3) -> list[dict]:
    """
    Пошук вразливостей у NVD API для конкретної програми
    """
    url = "https://services.nvd.nist.gov/rest/json/cves/2.0"
    params = {
        "keywordSearch": app_name,
        "resultsPerPage": limit
    }
    headers = {
        "User-Agent": "Homework-Vulnerability-Scanner"
    }

    results = []

    try:
        response = requests.get(url, params=params, headers=headers, timeout=30)
        response.raise_for_status()
        data = response.json()

        for item in data.get("vulnerabilities", []):
            cve = item.get("cve", {})
            cve_id = cve.get("id", "N/A")

            # Опис англійською
            descriptions = cve.get("descriptions", [])
            description = next(
                (d["value"] for d in descriptions if d.get("lang") == "en"),
                "No description available"
            )

            # CVSS
            score, severity = get_cvss_info(cve.get("metrics", {}))

            # Дата публікації
            published = cve.get("published", "N/A")
            if published != "N/A":
                published = published.split("T")[0]

            results.append({
                "App": app_name,            # назва програми
                "CVE ID": cve_id,           # ідентифікатор вразливості
                "Severity": severity,       # рівень небезпеки
                "Score": score,             # оцінка CVSS
                "Description": description, # опис вразливості
                "Published": published      # дата публікації
            })

    except requests.exceptions.RequestException as err:
        print(f"Помилка при запиті до API для {app_name}: {err}")

    return results


def main():
    all_results = []

    print("=" * 60)
    print("СКАНЕР ВРАЗЛИВОСТЕЙ")
    print("=" * 60)

    for index, app in enumerate(MY_APPS, 1):
        print(f"\n[{index}/{len(MY_APPS)}] Пошук вразливостей для '{app}'...")

        results = search_vulnerabilities(app, limit=3)
        print(f"  Знайдено: {len(results)} вразливостей")

        all_results.extend(results)

        print("  Очікування 6 секунд (rate limit)...")
        time.sleep(6)

    # Збереження у CSV
    fieldnames = ["App", "CVE ID", "Severity", "Score", "Description", "Published"]

    with open("my_vulnerabilities.csv", "w", newline="", encoding="utf-8") as f:
        writer = csv.DictWriter(f, fieldnames=fieldnames)
        writer.writeheader()
        writer.writerows(all_results)

    # Статистика
    total = len(all_results)
    critical = sum(1 for v in all_results if v["Severity"] == "CRITICAL")
    high = sum(1 for v in all_results if v["Severity"] == "HIGH")

    print("\n" + "=" * 60)
    print("РЕЗУЛЬТАТИ СКАНУВАННЯ")
    print("=" * 60)
    print(f"Всього вразливостей: {total}")  # загальна кількість знайдених вразливостей
    print(f"CRITICAL: {critical}")          # кількість критичних вразливостей
    print(f"HIGH: {high}")                  # кількість високих вразливостей
    print("CSV файл збережено як my_vulnerabilities.csv")

    # Підрахунок вразливостей за рівнем небезпеки
    severity_counts = {
        "CRITICAL": 0,
        "HIGH": 0,
        "MEDIUM": 0,
        "LOW": 0
    }

    for v in all_results:
        severity = v.get("Severity")
        if severity in severity_counts:
            severity_counts[severity] += 1

    # Візуалізація результатів (стовпчиковий графік)
    labels = list(severity_counts.keys())
    values = list(severity_counts.values())

    plt.figure()
    plt.bar(labels, values)
    plt.title("Розподіл вразливостей за рівнем небезпеки")
    plt.xlabel("Severity")
    plt.ylabel("Кількість CVE")
    plt.grid(axis="y")

    plt.show()

if __name__ == "__main__":
    main()